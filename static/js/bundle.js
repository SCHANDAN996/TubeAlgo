(()=>{function h(){return{isLoading:!1,loadingMessage:"",step:1,topic:PAGE_DATA.initialTopic||"",csrfToken:"",generatedTitles:[],selectedTitle:null,generatedContent:{description:"",outline:"",tags:{}},activeTab:"description",init(){let e=document.querySelector('input[name="csrf_token"]');e&&(this.csrfToken=e.value)},async generateTitles(){if(!this.topic.trim()){alert("Please enter a topic for your video.");return}this.isLoading=!0,this.loadingMessage="Generating Titles & Tags...";try{let e=await fetch(PAGE_DATA.urls.generateTitles,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify({topic:this.topic})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to generate titles.");this.generatedTitles=t.titles||[],this.generatedContent.tags=t.tags||{},this.selectedTitle=null,this.step=2}catch(e){alert("Error: "+e.message)}finally{this.isLoading=!1}},async generateFinalContent(){if(!this.selectedTitle){alert("Please select a title before proceeding.");return}this.isLoading=!0,this.loadingMessage="Generating final content...",this.activeTab="description";try{let e=fetch(PAGE_DATA.urls.generateDescription,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify({topic:this.topic,title:this.selectedTitle})}).then(r=>r.json()),t=fetch(PAGE_DATA.urls.generateScript,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify({topic:this.topic,title:this.selectedTitle})}).then(r=>r.json()),[i,s]=await Promise.all([e,t]);if(i.error||s.error)throw new Error(i.error||s.error||"Failed to generate content.");this.generatedContent.description=i.description||"Could not generate description.",this.generatedContent.outline=s.outline||"Could not generate script outline.",this.step=3}catch(e){alert("Error: "+e.message)}finally{this.isLoading=!1}},copyToClipboard(e,t){e&&navigator.clipboard.writeText(e).then(()=>{let i=t.textContent;t.textContent="Copied!",setTimeout(()=>{t.textContent=i},2e3)})},copyAllTags(e){if(!this.generatedContent||!this.generatedContent.tags)return;let t=[...this.generatedContent.tags.main_keywords||[],...this.generatedContent.tags.secondary_keywords||[],...this.generatedContent.tags.broad_tags||[]];this.copyToClipboard(t.join(", "),e)}}}document.addEventListener("alpine:init",()=>{Alpine.data("aiGeneratorPage",h)});function u(){return{showConfirmModal:!1,competitorToDelete:null,competitors:[],query:"",suggestions:[],loading:!1,showSuggestions:!1,activeIndex:-1,selectedChannelTitle:"",isAdding:!1,limit:-1,formError:"",showIdeaModal:!1,isGeneratingIdeas:!1,ideaSourceTitle:"",generatedIdeas:[],showAnalysisModal:!1,analysisLoading:!1,currentAnalysis:null,analysisError:"",videoForAnalysis:null,init(){this.competitors=JSON.parse(document.getElementById("competitors-data").textContent),this.limit=COMPETITOR_LIMIT,this.$watch("query",e=>{this.formError="",e!==this.selectedChannelTitle&&(this.$refs.hiddenIdInput&&(this.$refs.hiddenIdInput.value=""),this.selectedChannelTitle="")}),this.$el.addEventListener("confirm-delete",e=>this.confirmDelete(e.detail)),this.$el.addEventListener("move-competitor",e=>this.moveCompetitor(e.detail.id,e.detail.direction)),this.$el.addEventListener("go-to-analysis",e=>this.goToDeepAnalysis(e.detail.data,e.detail.competitor)),this.$el.addEventListener("analyze-transcript",e=>this.analyzeTranscript(e.detail.video))},get currentCount(){return this.competitors.length},get limitReached(){return this.limit!==-1&&this.currentCount>=this.limit},async handleAddCompetitor(){if(this.formError="",!this.$refs.hiddenIdInput.value){this.suggestions.length===1&&this.query.toLowerCase()===this.suggestions[0].title.toLowerCase()?(this.selectSuggestion(this.suggestions[0]),setTimeout(()=>this.handleAddCompetitor(),100)):this.formError="Please type and select a channel from the suggestion list.";return}if(this.isAdding)return;this.isAdding=!0;let e=this.$refs.addCompetitorForm,t={channel_url:this.query,channel_id_hidden:this.$refs.hiddenIdInput.value};try{let i=await fetch(e.action,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":e.querySelector("input[name=csrf_token]").value},body:JSON.stringify(t)}),s=await i.json();if(!i.ok)throw new Error(s.error||"An unknown error occurred.");s.success&&s.competitor&&(this.competitors.unshift(s.competitor),this.query="",this.$refs.hiddenIdInput&&(this.$refs.hiddenIdInput.value=""),this.suggestions=[])}catch(i){console.error("Error adding competitor:",i.message),this.formError=i.message}finally{this.isAdding=!1}},fetchSuggestions(){if(this.query.length<2){this.suggestions=[],this.showSuggestions=!1;return}this.loading=!0,this.showSuggestions=!0,fetch(`/api/search-channels?q=${this.query}`).then(e=>e.json()).then(e=>{this.suggestions=e,this.activeIndex=-1}).finally(()=>this.loading=!1)},selectSuggestion(e){this.query=e.title,this.selectedChannelTitle=e.title,this.$refs.hiddenIdInput.value=e.channel_id,this.showSuggestions=!1,this.activeIndex=-1},handleKeydown(e){!this.showSuggestions||this.suggestions.length===0||(e.key==="ArrowDown"?(e.preventDefault(),this.activeIndex=(this.activeIndex+1)%this.suggestions.length):e.key==="ArrowUp"?(e.preventDefault(),this.activeIndex=(this.activeIndex-1+this.suggestions.length)%this.suggestions.length):e.key==="Enter"&&(e.preventDefault(),this.activeIndex!==-1?this.selectSuggestion(this.suggestions[this.activeIndex]):this.handleAddCompetitor()))},confirmDelete(e){this.competitorToDelete=e,this.showConfirmModal=!0},proceedWithDelete(){this.competitorToDelete&&document.getElementById(`delete-form-${this.competitorToDelete}`).submit(),this.showConfirmModal=!1},moveCompetitor(e,t){let i=this.competitors.findIndex(a=>a.id===e);if(i===-1)return;let s=t==="up"?i-1:i+1;if(s<0||s>=this.competitors.length)return;[this.competitors[i],this.competitors[s]]=[this.competitors[s],this.competitors[i]];let r=document.querySelector('form[id="add-competitor-form"] input[name=csrf_token]').value;fetch(`/competitors/move/${e}/${t}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":r}}).then(a=>a.json()).then(a=>{a.success||([this.competitors[i],this.competitors[s]]=[this.competitors[s],this.competitors[i]],alert("Could not update position. Please refresh."))})},goToDeepAnalysis(e,t){sessionStorage.setItem("deepAnalysisPreload",JSON.stringify(e)),window.location.href=`/deep-analysis/${t.channel_id_youtube}`},analyzeTranscript(e){this.videoForAnalysis=e,this.showAnalysisModal=!0,this.analysisLoading=!0,this.currentAnalysis=null,this.analysisError="";let t=document.querySelector('form[id="add-competitor-form"] input[name=csrf_token]').value;fetch(`/api/competitor/analyze-transcript/${e.id}`,{method:"POST",headers:{"X-CSRFToken":t}}).then(i=>i.json()).then(i=>{i.error?(this.analysisError=i.error,this.currentAnalysis=null):(this.currentAnalysis={summary:i.summary||"Summary not available.",keywords:i.keywords||[],content_gaps:i.content_gaps||[]},this.analysisError="")}).catch(()=>{this.analysisError="An unexpected network error occurred.",this.currentAnalysis=null}).finally(()=>{this.analysisLoading=!1})},closeAnalysisModal(){this.showAnalysisModal=!1,this.videoForAnalysis=null,this.currentAnalysis=null,this.analysisError=""}}}function p(e){return{isLoading:!0,isRefreshing:!1,isRefreshed:!1,error:null,data:null,activeSort:"date",activeFilter:"all",allVideos:[],retryTimeout:null,ideaGenerationStatus:{},init(){let t=sessionStorage.getItem("deepAnalysisPreload");if(t)try{let i=JSON.parse(t);if(i&&i.details&&i.details.id===e.channel_id_youtube){this.data=i,this.processVideoSets(),this.isLoading=!1,this.error=null,sessionStorage.removeItem("deepAnalysisPreload");return}else sessionStorage.removeItem("deepAnalysisPreload")}catch{sessionStorage.removeItem("deepAnalysisPreload")}setTimeout(()=>this.fetchData(10),500)},fetchData(t=0){this.retryTimeout&&clearTimeout(this.retryTimeout),this.isLoading=!0,fetch(`/api/competitor/${e.id}/data`).then(i=>i.json()).then(i=>{(i.error||!i.details)&&t>0?this.retryTimeout=setTimeout(()=>this.fetchData(t-1),5e3):i.error?(this.error=i.error,this.isLoading=!1):(this.data=i,this.processVideoSets(),this.isLoading=!1,this.error=null)}).catch(()=>{t>0?this.retryTimeout=setTimeout(()=>this.fetchData(t-1),5e3):(this.error="Failed to load data after multiple attempts.",this.isLoading=!1)})},refreshData(){this.isRefreshing=!0,this.isRefreshed=!1;let t=document.querySelector('form[id="add-competitor-form"] input[name=csrf_token]').value;fetch(`/api/competitor/${e.id}/refresh`,{method:"POST",headers:{"X-CSRFToken":t}}).then(i=>i.json()).then(i=>{i.error?this.error=i.error:(this.data=i,this.processVideoSets(),this.isRefreshed=!0)}).catch(()=>this.error="Failed to refresh data.").finally(()=>this.isRefreshing=!1)},processVideoSets(){let t=this.data.recent_videos_data.videos||[],i=this.data.most_viewed_videos_data.videos||[],s={};[...t,...i].forEach(r=>{r&&r.id&&(s[r.id]=r)}),this.allVideos=Object.values(s).filter(Boolean)},get displayedVideos(){let t=[...this.allVideos];return this.activeFilter==="shorts"?t=t.filter(i=>i.is_short):this.activeFilter==="videos"&&(t=t.filter(i=>!i.is_short)),this.activeSort==="date"?t.sort((i,s)=>new Date(s.upload_date)-new Date(i.upload_date)):this.activeSort==="viewCount"?t.sort((i,s)=>s.view_count-i.view_count):this.activeSort==="most_comments"&&t.sort((i,s)=>s.comment_count-i.comment_count),t.slice(0,5)},addIdeaToPlanner(t){this.ideaGenerationStatus[t.id]="loading";let i=document.querySelector('form[id="add-competitor-form"] input[name=csrf_token]').value;fetch("/api/competitor/add-idea-from-video",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":i},body:JSON.stringify({title:t.title})}).then(s=>s.json()).then(s=>{s.success?this.ideaGenerationStatus[t.id]="success":(this.ideaGenerationStatus[t.id]="error",alert(s.error||"Failed to add idea."))}).catch(()=>{this.ideaGenerationStatus[t.id]="error",alert("An unexpected error occurred.")})}}}document.addEventListener("alpine:init",()=>{Alpine.data("competitorPage",u),Alpine.data("competitorCard",p)});function g(){return{isLoading:!0,error:null,data:{kpis:{},growth_chart:{labels:[],subscribers:[],views:[]},ai_assistant:[],top_recent_videos:[],goal:null,best_time_to_post:null,layout:null},chart:null,activeChartMetric:"subscribers",showGoalModal:!1,goalError:"",newGoal:{type:"subscribers",target:null,date:""},csrfToken:null,isSavingLayout:!1,saveStatus:"",showResetConfirmModal:!1,init(){let e=document.querySelector('input[name="csrf_token"]');e?this.csrfToken=e.value:console.error("CSRF Token input field not found!"),this.fetchData()},fetchData(){this.isLoading=!0,fetch(`/api/dashboard/main-data?t=${new Date().getTime()}`).then(e=>e.json()).then(e=>{this.data=e,this.error=null,this.$nextTick(()=>{this.applyLayout(),this.renderChart(),this.initSortable()})}).catch(e=>{this.error=e.message}).finally(()=>{this.isLoading=!1})},initSortable(){let e=document.getElementById("sortable-left"),t=document.getElementById("sortable-right"),i={group:"dashboard-cards",animation:150,handle:".drag-handle",onEnd:()=>this.saveLayout()};e&&!e.classList.contains("sortable-initialized")&&(new Sortable(e,i),e.classList.add("sortable-initialized")),t&&!t.classList.contains("sortable-initialized")&&(new Sortable(t,i),t.classList.add("sortable-initialized"))},applyLayout(){if(!this.data.layout||!this.data.layout.left||!this.data.layout.right)return;let e=document.getElementById("sortable-left"),t=document.getElementById("sortable-right");if(!e||!t)return;let i={};document.querySelectorAll("#sortable-left > [data-id], #sortable-right > [data-id]").forEach(s=>{i[s.dataset.id]=s}),this.data.layout.left.forEach(s=>{i[s]&&e.appendChild(i[s])}),this.data.layout.right.forEach(s=>{i[s]&&t.appendChild(i[s])})},async saveLayout(){this.isSavingLayout=!0,this.saveStatus="Saving...";let e=Array.from(document.getElementById("sortable-left").children).map(s=>s.dataset.id),t=Array.from(document.getElementById("sortable-right").children).map(s=>s.dataset.id),i={left:e,right:t};if(!this.csrfToken){console.error("CSRF Token not found! Cannot save layout."),this.saveStatus="Error!",this.isSavingLayout=!1;return}try{let s=await fetch("/api/dashboard/save-layout",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify(i)});if(!s.ok)throw new Error("Server responded with an error.");let r=await s.json();if(r.success)this.saveStatus="Saved!";else throw new Error(r.error||"Failed to save.")}catch(s){this.saveStatus="Error!",console.error("Failed to save layout:",s)}finally{this.isSavingLayout=!1,setTimeout(()=>{this.saveStatus=""},2e3)}},resetLayout(){this.showResetConfirmModal=!0},cancelReset(){this.showResetConfirmModal=!1},proceedWithReset(){this.showResetConfirmModal=!1;let e={left:["kpis","growth_chart","top_videos"],right:["goal","best_time","ai_assistant"]};this.data.layout=e,this.applyLayout(),this.saveLayout()},renderChart(){if(this.chart&&this.chart.destroy(),!this.$refs.growthChart||!this.data.growth_chart||!this.data.growth_chart.labels)return;let i=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim().replace(/ /g,","),s=this.$refs.growthChart.getContext("2d"),r=s.createLinearGradient(0,0,0,250);r.addColorStop(0,`hsla(${i}, 0.5)`),r.addColorStop(1,`hsla(${i}, 0)`);let a=localStorage.getItem("theme")||"light",o=a==="dark"?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",n=a==="dark"?"#cbd5e1":"#475569";this.chart=new Chart(s,{type:"line",data:{labels:this.data.growth_chart.labels,datasets:[{label:this.activeChartMetric.charAt(0).toUpperCase()+this.activeChartMetric.slice(1),data:this.data.growth_chart[this.activeChartMetric],borderColor:`hsl(${i})`,backgroundColor:r,borderWidth:2,pointBackgroundColor:`hsl(${i})`,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1,grid:{color:o},ticks:{color:n}},x:{grid:{display:!1},ticks:{color:n}}},plugins:{legend:{display:!1},tooltip:{backgroundColor:"hsl(var(--card))",titleColor:"hsl(var(--foreground))",bodyColor:"hsl(var(--foreground))",borderColor:"hsl(var(--border))",borderWidth:1}}}})},updateChart(e){this.activeChartMetric=e,this.renderChart()},getIconForSuggestion(e){switch(e){case"topic":return"fa-solid fa-lightbulb text-yellow-500";case"performance":return"fa-solid fa-arrow-trend-up text-green-500";case"consistency":return"fa-solid fa-calendar-days text-blue-500";default:return"fa-solid fa-star text-primary"}},openGoalModal(){this.goalError="",this.newGoal={type:"subscribers",target:null,date:""},this.showGoalModal=!0},async saveGoal(){if(this.goalError="",!this.newGoal.target||this.newGoal.target<=0){this.goalError="Please enter a valid target value.";return}try{let e={"Content-Type":"application/json"};if(this.csrfToken)e["X-CSRFToken"]=this.csrfToken;else{console.error("Cannot save goal: CSRF Token is missing."),this.goalError="Security token missing. Please refresh the page.";return}let t=await fetch("/api/goals/",{method:"POST",headers:e,body:JSON.stringify({goal_type:this.newGoal.type,target_value:this.newGoal.target,target_date:this.newGoal.date||null})});if(!t.ok){let i=await t.json();throw new Error(i.error||"Failed to save goal.")}this.showGoalModal=!1,this.fetchData()}catch(e){this.goalError=e.message}}}}document.addEventListener("alpine:init",()=>{Alpine.data("dashboard",g)});document.addEventListener("alpine:init",()=>{Alpine.data("contentPlanner",()=>({plannerData:{idea:[],scripting:[],filming:[],editing:[],scheduled:[]},plannerColumns:[{id:"idea",title:"\u{1F4A1} Ideas",icon:"\u{1F9E0}"},{id:"scripting",title:"\u270D\uFE0F Scripting",icon:"\u{1F4DD}"},{id:"filming",title:"\u{1F3AC} Filming",icon:"\u{1F3A5}"},{id:"editing",title:"\u2702\uFE0F Editing",icon:"\u{1F39E}\uFE0F"},{id:"scheduled",title:"\u{1F5D3}\uFE0F Scheduled",icon:"\u2705"}],columnColors:{idea:"border-blue-500",scripting:"border-purple-500",filming:"border-red-500",editing:"border-yellow-500",scheduled:"border-green-500"},ideaEntryMode:"button",newIdeaTitle:"",isGeneratorOpen:!1,generatorStep:"input",generatorTopic:"",generatorDescription:"",generatorVideoType:"any",generatorLanguage:"English",isGeneratorLoading:!1,loadingStepMessage:"",generatedIdeas:[],currentIdeaIndex:0,copyButtonText:"Copy Outline",isEditModalOpen:!1,editingIdea:{},editingStatus:"",editModalTab:"write",editModalCopyText:"Copy Notes",showDeleteConfirmModal:!1,ideaToDelete:null,isTranscriptModalOpen:!1,transcriptStep:"input",transcriptUrl:"",isTranscriptLoading:!1,transcriptError:"",transcriptTab:"voiceover",transcriptCopyText:"Copy",transcriptData:{original:"",voiceover:"",script:""},init(){this.loadPlannerData(),window.marked?window.marked.setOptions({breaks:!0,gfm:!0}):console.warn("MarkedJS not found. Markdown preview will not work.")},async loadPlannerData(){try{let t=await(await fetch(PAGE_DATA.urls.getIdeas)).json();this.plannerColumns.forEach(i=>{this.plannerData[i.id]=Array.isArray(t[i.id])?t[i.id]:[]}),this.$nextTick(()=>{this.initializeSortable()})}catch(e){console.error("Error loading planner data:",e),alert("Failed to load planner data. Please refresh the page.")}},initializeSortable(){if(typeof Sortable>"u"){console.error("SortableJS library is not loaded. Drag and drop will not work.");return}let e=this.$el.querySelectorAll("[data-status]");if(!e||e.length===0){console.warn("Planner columns ([data-status]) not found immediately. Will retry once."),setTimeout(()=>this.initializeSortableRetry(),100);return}e.forEach(t=>{if(!t){console.warn("A column element was null during Sortable initialization loop.");return}t.sortableInstance&&t.sortableInstance.destroy(),t.sortableInstance=Sortable.create(t,{group:"planner-ideas",handle:".drag-handle",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:i=>{this.handleDrop(i)}})})},initializeSortableRetry(){console.log("Retrying Sortable initialization...");let e=this.$el.querySelectorAll("[data-status]");if(!e||e.length===0){console.error("Planner columns ([data-status]) still not found on retry. Drag and drop might fail.");return}this.initializeSortable()},async handleDrop(e){let t=e.item.dataset.id,i=e.from.dataset.status,s=e.to.dataset.status,r=e.newIndex;if(!this.plannerData[i]){console.error(`Source column data for status "${i}" not found during handleDrop.`),this.loadPlannerData();return}let a=this.plannerData[i].findIndex(l=>l.id==t);if(a===-1){console.error(`Moved idea ID ${t} not found in local data for status "${i}".`),this.loadPlannerData();return}let[o]=this.plannerData[i].splice(a,1);this.plannerData[s]||(this.plannerData[s]=[]),this.plannerData[s].splice(r,0,o);let n={};this.plannerColumns.forEach(l=>{n[l.id]=(this.plannerData[l.id]||[]).map(d=>d.id)});try{let d=await(await fetch(PAGE_DATA.urls.moveIdea,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector('input[name="csrf_token"]').value},body:JSON.stringify(n)})).json();d.success?console.log("Card move saved successfully on server."):(console.error("Failed to save move on server:",d.message),alert(`Error saving changes: ${d.message||"Please try again."}`),this.loadPlannerData())}catch(l){console.error("Network error saving move:",l),alert("A network error occurred while saving the changes."),this.loadPlannerData()}},async addNewIdea(e=null,t=null){let i=e||this.newIdeaTitle.trim();if(!i)return;let s={title:i,notes:t,status:"idea"};try{let r=await fetch(PAGE_DATA.urls.createIdea,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector('input[name="csrf_token"]').value},body:JSON.stringify(s)});if(r.ok){let a=await r.json();this.plannerData.idea||(this.plannerData.idea=[]),this.plannerData.idea.push({id:a.id,title:a.title,display_title:a.display_title||a.title,notes:a.notes||null,status:a.status}),this.newIdeaTitle="",this.ideaEntryMode="button"}else{let a=await r.json();console.error("Failed to add idea:",a.error),alert(`Error adding idea: ${a.error}`)}}catch(r){console.error("Error adding new idea:",r),alert("A network error occurred while adding the idea.")}},editIdea(e,t,i="write"){this.editingIdea=JSON.parse(JSON.stringify(e)),this.editingIdea.display_title||(this.editingIdea.display_title=this.editingIdea.title),(this.editingIdea.notes===null||typeof this.editingIdea.notes>"u")&&(this.editingIdea.notes=""),this.editingStatus=t,this.editModalTab=i,this.isEditModalOpen=!0,this.editModalCopyText="Copy Notes"},async saveIdea(){if(!this.editingIdea||!this.editingIdea.id)return;let e=this.editingIdea.display_title?.trim()?this.editingIdea.display_title.trim():this.editingIdea.title,t={title:this.editingIdea.title,display_title:e,notes:this.editingIdea.notes},i=PAGE_DATA.urls.updateIdeaBase+this.editingIdea.id;try{let s=await fetch(i,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector('input[name="csrf_token"]').value},body:JSON.stringify(t)});if(s.ok){let r=await s.json(),a=this.editingStatus;if(this.plannerData[a]){let o=this.plannerData[a].findIndex(n=>n.id===r.id);o!==-1?this.plannerData[a][o]={...this.plannerData[a][o],title:r.title,display_title:r.display_title||r.title,notes:r.notes!==void 0?r.notes:null}:(console.warn(`Idea with ID ${r.id} not found in status "${a}" after update.`),this.loadPlannerData())}else console.warn(`Status column "${a}" not found in plannerData.`),this.loadPlannerData();this.isEditModalOpen=!1,this.editingIdea={}}else{let r=await s.json();console.error("Failed to update idea:",r.error),alert(`Error updating idea: ${r.error}`)}}catch(s){console.error("Error updating idea:",s),alert("A network error occurred while saving the idea.")}},copyEditScript(){let e=this.editingIdea.notes||"";navigator.clipboard.writeText(e).then(()=>{this.editModalCopyText="Copied!",setTimeout(()=>{this.editModalCopyText="Copy Notes"},2e3)}).catch(t=>{console.error("Failed to copy notes: ",t),alert("Could not copy notes. Please check browser permissions."),this.editModalCopyText="Copy Failed",setTimeout(()=>{this.editModalCopyText="Copy Notes"},2e3)})},moveCard(e,t,i){let s=this.plannerColumns.findIndex(a=>a.id===t),r=i==="next"?s+1:s-1;if(r>=0&&r<this.plannerColumns.length){let a=this.plannerColumns[r].id,o=this.$el.querySelector(`.group[data-id="${e.id}"]`),n=this.$el.querySelector(`[data-status="${t}"]`),l=this.$el.querySelector(`[data-status="${a}"]`);if(!o||!n||!l){console.error("DOM elements not found for simulating move. Aborting.",{ideaId:e.id,from:t,to:a}),alert("Could not move card due to an internal error. Please try dragging.");return}let d=l.querySelectorAll(".group[data-id]").length,c={item:o,from:n,to:l,newIndex:d};this.handleDrop(c)}},deleteIdea(e,t){this.ideaToDelete={id:e,status:t},this.showDeleteConfirmModal=!0},async proceedWithDelete(){if(!this.ideaToDelete)return;let{id:e,status:t}=this.ideaToDelete,i=PAGE_DATA.urls.deleteIdeaBase+e;try{let s=await fetch(i,{method:"DELETE",headers:{"X-CSRFToken":document.querySelector('input[name="csrf_token"]').value}});if(s.ok){if(this.plannerData[t]){let r=this.plannerData[t].findIndex(a=>a.id===e);r!==-1&&this.plannerData[t].splice(r,1)}}else{let r=await s.json();console.error("Failed to delete idea:",r.error),alert(`Error deleting idea: ${r.error}`)}}catch(s){console.error("Error deleting idea:",s),alert("A network error occurred while deleting the idea.")}finally{this.showDeleteConfirmModal=!1,this.ideaToDelete=null}},openGeneratorModal(){this.isGeneratorOpen=!0,this.generatorStep="input",this.generatedIdeas=[],this.currentIdeaIndex=0,this.generatorTopic="",this.generatorDescription="",this.generatorLanguage="English",this.generatorVideoType="any",this.$nextTick(()=>{this.$refs.generatorTopicInput?.classList.remove("border-red-500","focus:ring-red-500")})},async fetchGeneratedIdeas(e=!1,t=null){let i=this.$refs.generatorTopicInput;if(!this.generatorTopic.trim()&&!e){i?.classList.add("border-red-500","focus:ring-red-500"),i?.focus();return}i?.classList.remove("border-red-500","focus:ring-red-500"),this.isGeneratorLoading=!0,this.generatorStep="results",this.loadingStepMessage="Initializing AI...";let s=t||this.generatorLanguage;t&&(this.generatorLanguage=t);let r;try{let a=["Analyzing topic...","Generating creative angles...","Writing script outlines..."],o=0;r&&clearInterval(r),r=setInterval(()=>{if(!this.isGeneratorLoading){clearInterval(r);return}o<a.length?(this.loadingStepMessage=a[o],o++):this.loadingStepMessage="Finalizing results..."},1500);let n=await fetch(PAGE_DATA.urls.generateIdeas,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector('input[name="csrf_token"]').value},body:JSON.stringify({topic:this.generatorTopic,description:this.generatorDescription,language:s,video_type:this.generatorVideoType})});r&&clearInterval(r);let l=await n.json(),d=[];if(n.ok&&l.ideas&&Array.isArray(l.ideas)?d=l.ideas:n.ok&&Array.isArray(l)&&(d=l),d.length>0)this.generatedIdeas=d.map(c=>({title:c.title||"Untitled Idea",outline:c.outline||""})),this.currentIdeaIndex=0,this.copyButtonText="Copy Outline";else{let c="Could not generate ideas. The AI might be unavailable or the response was invalid.";n.status===429?c=l?.error||"You have exceeded the AI generation limit for today.":l?.error?c=l.error:n.ok?d.length===0&&(c="The AI did not return any ideas for this topic."):c=`Server error (${n.status}). Please try again later.`,console.error("AI Generation failed:",c,l),this.generatedIdeas=[{title:"Generation Failed",outline:c}],this.currentIdeaIndex=0}}catch(a){r&&clearInterval(r),console.error("Error fetching generated ideas:",a),this.generatedIdeas=[{title:"Network Error",outline:"Could not connect to the AI service. Please check your connection."}],this.currentIdeaIndex=0}finally{this.isGeneratorLoading=!1,this.loadingStepMessage=""}},previousIdea(){this.currentIdeaIndex>0&&(this.currentIdeaIndex--,this.copyButtonText="Copy Outline")},nextIdea(){this.currentIdeaIndex<this.generatedIdeas.length-1&&(this.currentIdeaIndex++,this.copyButtonText="Copy Outline")},copyScript(){if(this.generatedIdeas.length>0&&this.currentIdeaIndex<this.generatedIdeas.length&&this.generatedIdeas[this.currentIdeaIndex]){let e=this.generatedIdeas[this.currentIdeaIndex].outline||"";navigator.clipboard.writeText(e).then(()=>{this.copyButtonText="Copied!",setTimeout(()=>{this.copyButtonText="Copy Outline"},2e3)}).catch(t=>{console.error("Failed to copy outline: ",t),alert("Could not copy outline. Please check browser permissions."),this.copyButtonText="Copy Failed",setTimeout(()=>{this.copyButtonText="Copy Outline"},2e3)})}else console.warn("No valid idea selected to copy outline.")},saveIdeaToPlanner(){if(this.generatedIdeas.length>0&&this.currentIdeaIndex<this.generatedIdeas.length&&this.generatedIdeas[this.currentIdeaIndex]){let e=this.generatedIdeas[this.currentIdeaIndex];e.title&&!e.title.includes("Failed")&&!e.title.includes("Error")?(this.addNewIdea(e.title,e.outline),this.isGeneratorOpen=!1):alert("Cannot save an idea that resulted in an error or is incomplete.")}else console.warn("No valid idea selected to save.")},openTranscriptModal(){this.isTranscriptModalOpen=!0,this.transcriptStep="input",this.transcriptUrl="",this.transcriptError="",this.transcriptData={original:"",voiceover:"",script:""},this.$nextTick(()=>{this.$refs.transcriptUrlInput?.classList.remove("border-red-500","focus:ring-red-500")})},closeTranscriptModal(){this.isTranscriptModalOpen=!1},async fetchTranscript(){let e=this.$refs.transcriptUrlInput;if(!this.transcriptUrl.trim()){this.transcriptError="Please enter a YouTube URL.",e?.classList.add("border-red-500","focus:ring-red-500"),e?.focus();return}let t=null,i=!1;try{let s=new URL(this.transcriptUrl),r=s.hostname.toLowerCase(),a=s.pathname,o=s.searchParams;r.includes("youtube.com")?a==="/watch"&&o.has("v")?t=o.get("v"):a.startsWith("/shorts/")&&(t=a.split("/shorts/")[1]?.split("?")[0]):r.includes("youtu.be")&&(t=a.substring(1).split("?")[0]),t&&/^[a-zA-Z0-9_-]{11}$/.test(t)&&(i=!0)}catch{let r=this.transcriptUrl.trim();/^[a-zA-Z0-9_-]{11}$/.test(r)?(t=r,i=!0):i=!1}if(!i){this.transcriptError="Please enter a valid YouTube video URL or Video ID.",e?.classList.add("border-red-500","focus:ring-red-500"),e?.focus();return}e?.classList.remove("border-red-500","focus:ring-red-500"),this.isTranscriptLoading=!0,this.transcriptError="";try{let s=this.transcriptUrl,r=await fetch(PAGE_DATA.urls.importTranscript,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector('input[name="csrf_token"]').value},body:JSON.stringify({url:s})}),a=await r.json();if(r.ok){this.transcriptData={original:a.original||"Original transcript not available.",voiceover:a.voiceover||"AI Voiceover script generation failed or not available.",script:a.script||"AI Full script generation failed or not available."},this.transcriptStep="results";let o=typeof this.transcriptData.voiceover!="string"||this.transcriptData.voiceover.startsWith("Error:")||this.transcriptData.voiceover.includes("failed or not available"),n=typeof this.transcriptData.script!="string"||this.transcriptData.script.startsWith("Error:")||this.transcriptData.script.includes("failed or not available");o&&n?(this.transcriptTab="original",this.transcriptError="Original transcript fetched, but AI processing failed."):this.transcriptTab="voiceover",this.transcriptCopyText="Copy"}else{let o=a.error||`Failed to process request (${r.status}).`;if(r.status===429&&(o=a.error||"AI processing limit reached. Cannot generate AI versions.",a.original)){this.transcriptData={original:a.original,voiceover:`Error: ${o}`,script:`Error: ${o}`},this.transcriptStep="results",this.transcriptTab="original",this.transcriptCopyText="Copy",this.transcriptError=o;return}this.transcriptError=o,a.original||(this.transcriptStep="input")}}catch(s){this.transcriptError="A network error occurred. Please check your connection and try again.",console.error("Fetch transcript error:",s)}finally{this.isTranscriptLoading=!1}},copyTranscript(){let e="",t="";this.transcriptTab==="original"?t=this.transcriptData.original:this.transcriptTab==="voiceover"?t=this.transcriptData.voiceover:this.transcriptTab==="script"&&(t=this.transcriptData.script),e=typeof t=="string"?t:"";let i=["Original transcript not available.","AI Voiceover script generation failed or not available.","AI Full script generation failed or not available."],s=e.startsWith("Error:");if(!e||i.includes(e)||s){console.warn("Nothing substantial to copy for tab:",this.transcriptTab),this.transcriptCopyText=s?"Cannot Copy Error":"Nothing to Copy",setTimeout(()=>{this.transcriptCopyText="Copy"},2e3);return}navigator.clipboard.writeText(e.trim()).then(()=>{this.transcriptCopyText="Copied!",setTimeout(()=>{this.transcriptCopyText="Copy"},2e3)}).catch(r=>{console.error("Failed to copy text: ",r),this.transcriptCopyText="Copy Failed",alert("Could not copy text. Please check browser permissions."),setTimeout(()=>{this.transcriptCopyText="Copy"},2e3)})},addTranscriptToPlanner(){let e="New Idea from Transcript",t=null;try{let o=this.transcriptUrl.match(/(?:v=|\/shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);t=o?o[1]:null,t&&(e=`Idea from YT: ${t}`)}catch{console.warn("Could not parse video ID from URL for title.")}let i="",s="",r="";if(this.transcriptTab==="original"?(s=this.transcriptData.original,r="# Original Transcript"):this.transcriptTab==="voiceover"?(s=this.transcriptData.voiceover,r="# AI-Ready Voiceover"):this.transcriptTab==="script"&&(s=this.transcriptData.script,r="# AI Full Script"),(typeof s!="string"||s.startsWith("Error:")||s==="Original transcript not available."||s.includes("failed or not available"))&&this.transcriptTab!=="original"){let o=typeof s=="string"?`

Note: ${s}`:`

Note: AI processed version was unavailable.`,n=this.transcriptData.original||"(Original transcript data not available)";i=`# Original Transcript (AI Failed/Unavailable)

${n}${o}`,n==="(Original transcript data not available)"&&(i=`# Imported Idea: ${e}

(Transcript data could not be retrieved or processed.)`)}else s&&typeof s=="string"&&s!=="Original transcript not available."?i=`${r}

${s}`:i=`# Imported Idea: ${e}

(Transcript data was empty or unavailable.)`;this.addNewIdea(e,i),this.closeTranscriptModal()}}))});function f(){return{videos:[],filter:"all",sortBy:"newest",selectedVideos:[],showBulkEditModal:!1,showConfirmModal:!1,bulkEditData:{tags_to_add:"",tags_to_remove:"",description_append:"",privacy_status:""},isBulkUpdating:!1,disclaimerChecked:!1,bulkEditMode:!1,userPlan:"free",dailyLimit:0,editsUsedToday:0,remainingEdits:0,limitMessage:"",isIndeterminate:!1,init(){typeof PAGE_DATA<"u"?(this.videos=PAGE_DATA.videos||[],this.dailyLimit=parseInt(PAGE_DATA.dailyLimit),(isNaN(this.dailyLimit)||this.dailyLimit<0&&this.dailyLimit!==-1)&&(console.warn("Invalid dailyLimit received, defaulting to 0."),this.dailyLimit=0),this.dailyLimit===-1&&(this.dailyLimit=1/0),this.editsUsedToday=parseInt(PAGE_DATA.editsUsedToday)||0,this.userPlan=PAGE_DATA.userPlan||"free"):(console.error("PAGE_DATA is not defined. Bulk edit limits and video list might not work correctly."),this.videos=[],this.dailyLimit=0),this.calculateRemaining(),this.checkSelectionLimit(),this.$watch("selectedVideos",()=>{this.calculateRemainingBasedOnSelection(),this.updateIndeterminateState()}),this.$watch("bulkEditMode",e=>{e?this.calculateRemaining():(this.limitMessage="",this.isIndeterminate=!1)})},calculateRemaining(){this.dailyLimit===1/0?this.remainingEdits=1/0:this.remainingEdits=Math.max(0,this.dailyLimit-this.editsUsedToday)},calculateRemainingBasedOnSelection(){this.dailyLimit===1/0?this.remainingEdits=1/0:this.remainingEdits=Math.max(0,this.dailyLimit-this.editsUsedToday)},getLimitMessage(){if(this.dailyLimit===1/0)return"";let e=this.dailyLimit;return`You can select ${Math.max(0,this.dailyLimit-this.editsUsedToday)} more videos today (${this.editsUsedToday}/${e} used for ${this.userPlan.charAt(0).toUpperCase()+this.userPlan.slice(1)} plan).`},checkSelectionLimit(){let e=this.selectedVideos.length,t=this.dailyLimit===1/0?1/0:Math.max(0,this.dailyLimit-this.editsUsedToday);this.updateIndeterminateState()},updateIndeterminateState(){let e=this.filteredAndSortedVideos.map(r=>r.id),t=e.filter(r=>this.selectedVideos.includes(r)).length;if(e.length===0||!this.bulkEditMode){this.isIndeterminate=!1;return}let i=this.dailyLimit===1/0?1/0:Math.max(0,this.dailyLimit-this.editsUsedToday-this.selectedVideos.length+t),s=Math.min(e.length,t+i);t===0?this.isIndeterminate=!1:t>=s&&e.length===s?this.isIndeterminate=!1:t>0&&t<e.length?this.isIndeterminate=!0:this.isIndeterminate=!1},get isAllSelected(){let e=this.filteredAndSortedVideos.map(r=>r.id);if(e.length===0||!this.bulkEditMode)return!1;let t=this.dailyLimit===1/0?1/0:Math.max(0,this.dailyLimit-this.editsUsedToday-(this.selectedVideos.length-e.filter(r=>this.selectedVideos.includes(r)).length)),i=Math.min(e.length,t+e.filter(r=>this.selectedVideos.includes(r)).length);return e.filter(r=>this.selectedVideos.includes(r)).length>=i&&i>0},get filteredAndSortedVideos(){if(!Array.isArray(this.videos))return console.error("this.videos is not an array:",this.videos),[];let e=[...this.videos];return this.filter==="shorts"?e=e.filter(t=>t.is_short):this.filter==="videos"&&(e=e.filter(t=>!t.is_short)),this.sortBy==="newest"?e.sort((t,i)=>{let s=t.published_at?new Date(t.published_at):0;return(i.published_at?new Date(i.published_at):0)-s}):this.sortBy==="views"&&e.sort((t,i)=>(i.view_count||0)-(t.view_count||0)),e},toggleBulkEditMode(){this.bulkEditMode=!this.bulkEditMode,this.bulkEditMode||(this.selectedVideos=[]),this.limitMessage="",this.isIndeterminate=!1,this.calculateRemaining()},toggleSelectAll(e){if(!this.bulkEditMode)return;let t=this.filteredAndSortedVideos.map(r=>r.id),i=this.selectedVideos.filter(r=>!t.includes(r)),s=t.filter(r=>this.selectedVideos.includes(r));if(e.target.checked){let r=this.dailyLimit===1/0?1/0:Math.max(0,this.dailyLimit-this.editsUsedToday-i.length),a=t.filter(o=>!this.selectedVideos.includes(o)).slice(0,r);this.selectedVideos=[...i,...s,...a],a.length<t.length-s.length?(this.limitMessage=`Selected ${a.length} more videos due to daily limit.`,setTimeout(()=>this.limitMessage="",3e3),e.target.checked=!1,this.isIndeterminate=this.selectedVideos.length>0):(this.limitMessage="",this.isIndeterminate=!1)}else this.selectedVideos=i,this.limitMessage="",this.isIndeterminate=!1;this.calculateRemaining(),this.updateIndeterminateState()},handleCardClick(e){if(this.bulkEditMode){let t=this.selectedVideos.indexOf(e);if(t>-1)this.selectedVideos.splice(t,1),this.limitMessage="";else if((this.dailyLimit===1/0?1:Math.max(0,this.dailyLimit-this.editsUsedToday-this.selectedVideos.length))<=0){this.calculateRemaining(),this.limitMessage=this.getLimitMessage(),setTimeout(()=>this.limitMessage="",3e3);return}else this.selectedVideos.push(e),this.limitMessage="";this.calculateRemainingBasedOnSelection(),this.updateIndeterminateState()}},openBulkEditModal(){this.bulkEditData={tags_to_add:"",tags_to_remove:"",description_append:"",privacy_status:""},this.disclaimerChecked=!1,this.showBulkEditModal=!0},submitBulkEdit(){if(this.selectedVideos.length===0){alert("Please select at least one video.");return}if(!this.disclaimerChecked){alert("Please read and acknowledge the disclaimer by checking the box before proceeding.");return}let e=this.dailyLimit===1/0?1/0:Math.max(0,this.dailyLimit-this.editsUsedToday);if(this.selectedVideos.length>e){alert(`You have selected ${this.selectedVideos.length} videos, but you can only edit ${e} more today based on your plan limit.`);return}this.showConfirmModal=!0},async proceedWithBulkEdit(){this.showConfirmModal=!1,this.isBulkUpdating=!0;let e={video_ids:this.selectedVideos,operations:this.bulkEditData},t=0,i=null,s=this.editsUsedToday;try{let r=document.querySelector('input[name="csrf_token"]').value,a=await fetch("/manage/videos/bulk-edit",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":r},body:JSON.stringify(e)});if(t=a.status,i=await a.json(),!a.ok)throw new Error(i.error||`Server error: ${a.status}`);alert(i.message),window.location.reload()}catch(r){t===429?(alert("Error: "+(i.error||"Daily bulk edit limit exceeded.")),this.disclaimerChecked=!1):(alert("Error: "+r.message),this.showBulkEditModal=!1)}finally{t>=200&&t<300||(this.isBulkUpdating=!1),t===429&&(this.isBulkUpdating=!1)}},formatRelativeTime(e){if(!e)return"";try{let t=new Date(e),s=new Date().getTime()-t.getTime(),r=Math.round(s/1e3);if(r<60)return"just now";let a=Math.floor(r/60);if(a<60)return`${a}m ago`;let o=Math.floor(a/60);if(o<24)return`${o}h ago`;let n=Math.floor(o/24);return n<7?`${n}d ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}catch(t){return console.error("Error formatting date:",e,t),"Invalid Date"}}}}document.addEventListener("alpine:init",()=>{Alpine.data("videoManager",f)});})();
